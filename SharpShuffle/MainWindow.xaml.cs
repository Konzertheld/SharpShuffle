using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
using System.Collections.ObjectModel;
using System.Windows.Controls.Primitives;

namespace SharpShuffle
{
    delegate void FakeDelegate();

    /// <summary>
    /// Interaktionslogik für MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        ObservableCollection<Song> songs = new ObservableCollection<Song>();

        Player player;

        bool[] hiddenColumns;

        public MainWindow()
        {
            InitializeComponent();
            player = new Player();
            player.PositionChanged += new PlayerPositionChangedHandler(player_PositionChanged);
            player.PlaylistEnded += new PlaylistEndedHandler(player_PlaylistEnded);
            List<Song> fake = Startup.ActiveDB.LoadSongs("__VIEW");
            for (int i = 0; i < int.MaxValue; i++)
                player.PlayedHistory.Add(fake[0]);
            try
            {
                System.Runtime.Serialization.Formatters.Binary.BinaryFormatter bf = new System.Runtime.Serialization.Formatters.Binary.BinaryFormatter();
                hiddenColumns = (bool[])bf.Deserialize(new System.IO.FileStream("c:\\cols.dat", System.IO.FileMode.Open));
            }
            catch (Exception) { }

            RefreshView();

            lsvFilterPool.ItemsSource = Startup.ActiveDB.PoolList(false);

            dgrView.ItemsSource = songs;
            dgrView.AutoGeneratedColumns += new EventHandler(dgrView_AutoGeneratedColumns);

            lsvPlaylist.ItemsSource = player.Playlist;
            ((GridView)(lsvPlaylist.View)).Columns.Add(new GridViewColumn());
            ((GridView)(lsvPlaylist.View)).Columns.Add(new GridViewColumn());
            ((GridView)(lsvPlaylist.View)).Columns[0].DisplayMemberBinding = new Binding("Artists");
            ((GridView)(lsvPlaylist.View)).Columns[1].DisplayMemberBinding = new Binding("Title");
        }

        void player_PlaylistEnded()
        {
            MessageBox.Show("Playlist ended");
        }

        private void RefreshView()
        {
            songs = new System.Collections.ObjectModel.ObservableCollection<Song>(Startup.ActiveDB.LoadSongs("__VIEW"));
            dgrView.ItemsSource = songs;
        }

        void player_PositionChanged(double position)
        {
            prgPosition.Dispatcher.Invoke(new FakeDelegate(delegate
            {
                prgPosition.Value = 100 - position * 100;
            }));
        }

        void dgrView_AutoGeneratedColumns(object sender, EventArgs e)
        {
            if (hiddenColumns == null)
            {
                hiddenColumns = new bool[dgrView.Columns.Count];
                for (int i = 0; i < hiddenColumns.Count(); i++) hiddenColumns[i] = true;
            }

            for (int i = 0; i < dgrView.Columns.Count; i++)
            {
                MenuItem item = new MenuItem();
                item.Header = dgrView.Columns[i].Header;
                item.IsChecked = hiddenColumns[i];
                menSpalten.Items.Add(item);
                item.Click += new RoutedEventHandler(dgrViewColumn_Click);
                item.Checked += new RoutedEventHandler(dgrViewColumn_Checked);
                item.Unchecked += new RoutedEventHandler(dgrViewColumn_Unchecked);
                item.Tag = i;
                dgrView.Columns[i].Visibility = (hiddenColumns[i]) ? System.Windows.Visibility.Visible : System.Windows.Visibility.Collapsed;
            }
        }

        void dgrViewColumn_Unchecked(object sender, RoutedEventArgs e)
        {
            MenuItem item = sender as MenuItem;
            dgrView.Columns[(int)item.Tag].Visibility = System.Windows.Visibility.Collapsed;
            hiddenColumns[(int)item.Tag] = false;
        }

        void dgrViewColumn_Checked(object sender, RoutedEventArgs e)
        {
            MenuItem item = sender as MenuItem;
            dgrView.Columns[(int)item.Tag].Visibility = System.Windows.Visibility.Visible;
            hiddenColumns[(int)item.Tag] = true;
        }

        void dgrViewColumn_Click(object sender, RoutedEventArgs e)
        {
            MenuItem item = sender as MenuItem;
            item.IsChecked = !item.IsChecked;
        }

        private void Window_Closed(object sender, EventArgs e)
        {
            System.Runtime.Serialization.Formatters.Binary.BinaryFormatter bf = new System.Runtime.Serialization.Formatters.Binary.BinaryFormatter();
            bf.Serialize(new System.IO.FileStream("c:\\cols.dat", System.IO.FileMode.Create), hiddenColumns);
        }

        private void dgrView_MouseDoubleClick(object sender, MouseButtonEventArgs e)
        {
            player.Playlist.Add(dgrView.SelectedItem as Song);
            player.PlayPlaylist();
        }

        private void lsvFilterPool_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            Songpool view = new Songpool("__VIEW");
            view.Clear();
            foreach (string pool in lsvFilterPool.SelectedItems)
            {
                view.AddSongs(pool);
            }
            RefreshView();
        }

        private void menShowHistory_Click(object sender, RoutedEventArgs e)
        {
            lsvFilterPool.SelectedItems.Clear();
            songs = new ObservableCollection<Song>(player.PlayedHistory);
            dgrView.ItemsSource = songs;
        }
    }
}
